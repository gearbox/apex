# Apex API - Production Overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  postgres:
    # In production, don't expose port externally
    ports: []
    environment:
      # Use stronger password in production (set via .env)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    # Don't build in production - use pre-built image
    image: ${API_IMAGE:-apex-api:latest}
    build: []
    environment:
      DEBUG: "false"
      # Require R2 credentials in production
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID:?R2_ACCOUNT_ID is required}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:?R2_ACCESS_KEY_ID is required}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:?R2_SECRET_ACCESS_KEY is required}
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Restart always in production
    restart: always

  migrations:
    image: ${API_IMAGE:-apex-api:latest}
    build: []
